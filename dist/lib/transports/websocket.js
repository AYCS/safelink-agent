/*! 
 safelink - v0.10.3 - 2014-05-09
(C) 2014 Joel Grenon. Distributed under the Apache Version 2.0, January 2004. See attached license
*/var WebSocket=require("ws"),JSON3=require("json3"),_=require("lodash"),Q=require("q");module.exports=function(){function a(a,b){this.log=b,this.layer=a}return a.prototype.init=function(a){var b=this;this.log.info("Initializing web socket transport"),this.ws=new WebSocket(a.dispatcher),this.ws.on("open",function(){b.log.debug("WS dispatcher link was successfully established"),b.wsopen=!0}),this.ws.on("close",function(){b.log.warn("WebSocket connection has been closed"),b.wsopen=!1}),this.ws.on("message",function(a){b.log.debug("WS message received",a);var c=JSON3.parse(a),d=b.layer.getResult(c.uuid);d?"message-response"===c.key?(b.log.debug("Received response for message %s(%s)",d.key,c.uuid),d.defer.resolve(c)):"message-error"===c.key?(b.log.warn("Received error for message %s(%s)",d.key,c.uuid,c.error),d.defer.reject(c.error)):(b.log.warn("Received an unsupported response for message %s(%s)",d.key,c.uuid,{content:c}),d.defer.reject({msg:"unknown response from dispatcher",error:c.error})):b.log.error("Unknown message %s(%s). Response will not be processed",c.key,c.uuid,{content:c})})},a.prototype.isAvailable=function(){return this.wsopen},a.prototype.send=function(a,b,c,d){var e=Q.defer(),f=_.extend(d||{},{id:a.id,uuid:b,key:c,v:a.version});return this.ws.send(JSON3.stringify(f),function(a){a&&e.reject(a)}),e.promise},a}();