/*! 
 safelink - v0.10.3 - 2014-05-09
(C) 2014 Joel Grenon. Distributed under the Apache Version 2.0, January 2004. See attached license
*/!function(){var a=require("moment"),b=function(){function b(b,c){var d=this,e=b.interval||30;this.agent=b,c.log.debug("Installing agent %s watchdog at an interval of %d seconds",b.id,2*e),this.watchDogInterval=setInterval(function(){c.log.debug("Executing watchdog check for agent ",b.id),c.db.multi().hget(b.id,"lastHeartbeatTs").hget(b.id,"status").exec(function(f,g){var h;c.log.trace(g,"Agent %s current state",b.id);try{h=a().utc().unix()-a(1e3*parseInt(g[0])).utc().unix()+5}catch(i){c.log.warn("Unable to compute delta",i),h=0}c.log.debug("%d seconds since last heartbeat for agent %s",h,b.id),h>2*e?(c.db.hset(b.id,"status","DISCONNECTED"),"CONNECTED"===g[1]&&(c.log.warn("Watchdog Report: Agent %s is disconnected. Last heartbeat we received was %d",b.id,g[0]),c.emit("agent-disconnected",{id:b.id,lastHeartbeatTs:g[0]})),c.log.info("Removing watchdog for agent %s",b.id),clearInterval(d.watchDogInterval)):c.log.debug("Watchdog Report: Agent %s is still connected",b.id)})},2e3*e)}return b}();module.exports=b}();